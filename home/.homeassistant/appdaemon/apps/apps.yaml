global_modules:
    - mutex_graph

locker:
    module: locker
    class: Locker
    global_dependencies: mutex_graph
    enable_logging: false

wind_direction_yr:
    class: WindDirection
    module: wind_direction
    entity: sensor.yr_wind_direction

wind_direction:
    class: WindDirection
    module: wind_direction
    entity: sensor.wind_direction

wind_direction_average_icon:
    class: WindDirection
    module: wind_direction
    entity: sensor.wind_direction_average

heating_pump:
    class: TemperatureBasic
    module: temperature_basic
    dependencies: locker
    sensor_out: sensor.temperature_furnace_wood
    sensor_in: sensor.temperature_furnace_wood_in
    outside_sensor: sensor.temperature_outside
    target: switch.heating_pump
    target_difference: 6
    tolerance: 1
    maximum_out: 80
    minimum_out: 30

auto_switch_light_driveway:
    module: auto_switch
    class: AutoSwitch
    dependencies: locker
    target: switch.light_driveway
    switch: input_select.light_driveway
    reentrant: true

auto_switch_light_gate_reflector:
    module: auto_switch
    class: AutoSwitch
    dependencies: locker
    target: switch.light_gate_reflector
    switch: input_select.light_gate_reflector
    reentrant: true

auto_switch_light_garage:
    module: auto_switch
    class: AutoSwitch
    dependencies: locker
    target: switch.light_garage
    switch: input_select.light_garage
    reentrant: true

auto_switch_light_outside_1:
    module: auto_switch
    class: AutoSwitch
    dependencies: locker
    target: switch.light_outside_1
    switch: input_select.light_outside_1
    reentrant: true

auto_switch_light_outside_2:
    module: auto_switch
    class: AutoSwitch
    dependencies: locker
    target: switch.light_outside_2
    switch: input_select.light_outside_2
    reentrant: true

auto_switch_light_outside_3:
    module: auto_switch
    class: AutoSwitch
    dependencies: locker
    target: switch.light_outside_3
    switch: input_select.light_outside_3
    reentrant: true

auto_switch_light_outside_4:
    module: auto_switch
    class: AutoSwitch
    dependencies: locker
    target: switch.light_outside_4
    switch: input_select.light_outside_4
    reentrant: true

auto_switch_light_outside_5:
    module: auto_switch
    class: AutoSwitch
    dependencies: locker
    target: switch.light_outside_5
    switch: input_select.light_outside_5
    reentrant: true

auto_switch_light_outside_6:
    module: auto_switch
    class: AutoSwitch
    dependencies: locker
    target: switch.light_outside_6
    switch: input_select.light_outside_6
    reentrant: true

sun_enabler_night:
    module: enabler
    class: ValueEnabler
    dependencies: locker
    entity: binary_sensor.night
    value: 'on'

wind_short_term:
    module: history
    class: HistoryManager
    dependencies: locker
    entity: sensor.wind_strength

wind_direction_short_term:
    module: history
    class: HistoryManager
    dependencies: locker
    entity: sensor.wind_direction

wind_disabler:
    module: enabler
    class: HistoryEnabler
    dependencies:
        - wind_short_term
        - locker
    manager: wind_short_term
    aggregator: max
    max: 50
    interval:
        minutes: 10
    default: 0

wind_direction_average:
    module: history
    class: AggregatedValue
    dependencies:
        - wind_direction_short_term
        - locker
    manager: wind_direction_short_term
    target: sensor.wind_direction_average
    interval:
        minutes: 10
    base_interval:
        seconds: 10
    aggregator: anglemean
    attributes:
        unit_of_measurement: "°"
        friendly_name: "Szélirány"

motion_sensor_driveway_uppest_history:
    module: history
    class: HistoryManager
    dependencies: locker
    entity: binary_sensor.motion_sensor_driveway_uppest

motion_sensor_driveway_uppest_average:
    module: history
    class: AggregatedValue
    dependencies:
        - motion_sensor_driveway_uppest_history
        - locker
    manager: motion_sensor_driveway_uppest_history
    target: sensor.motion_sensor_driveway_uppest_average
    interval:
        hours: 1
    aggregator: mean
    attributes:
        friendly_name: "Bejáró legfelső"
        icon: mdi:percent

motion_sensor_driveway_uppest_lockout:
    module: enabler
    class: RangeEnabler
    dependencies:
        - locker
        - motion_sensor_driveway_uppest_average
    entity: sensor.motion_sensor_driveway_uppest_average
    max: 0.2

motion_sensor_driveway_uppest_enabler:
    module: enabler
    class: MultiEnabler
    dependencies:
        - motion_sensor_driveway_uppest_lockout
        - sun_enabler_night
        - locker
    enablers:
        - motion_sensor_driveway_uppest_lockout
        - sun_enabler_night

motion_sensor_driveway_upper_history:
    module: history
    class: HistoryManager
    dependencies: locker
    entity: binary_sensor.motion_sensor_driveway_upper

motion_sensor_driveway_upper_average:
    module: history
    class: AggregatedValue
    dependencies:
        - motion_sensor_driveway_upper_history
        - locker
    manager: motion_sensor_driveway_upper_history
    target: sensor.motion_sensor_driveway_upper_average
    interval:
        hours: 1
    aggregator: mean
    attributes:
        friendly_name: "Bejáró felső"
        icon: mdi:percent

motion_sensor_driveway_upper_lockout:
    module: enabler
    class: RangeEnabler
    dependencies:
        - locker
        - motion_sensor_driveway_upper_average
    entity: sensor.motion_sensor_driveway_upper_average
    max: 0.2

motion_sensor_driveway_upper_enabler:
    module: enabler
    class: MultiEnabler
    dependencies:
        - motion_sensor_driveway_upper_lockout
        - sun_enabler_night
        - locker
    enablers:
        - motion_sensor_driveway_upper_lockout
        - sun_enabler_night

motion_sensor_driveway_lower_history:
    module: history
    class: HistoryManager
    dependencies: locker
    entity: binary_sensor.motion_sensor_driveway_lower

motion_sensor_driveway_lower_average:
    module: history
    class: AggregatedValue
    dependencies:
        - motion_sensor_driveway_lower_history
        - locker
    manager: motion_sensor_driveway_lower_history
    target: sensor.motion_sensor_driveway_lower_average
    interval:
        hours: 1
    aggregator: mean
    attributes:
        friendly_name: "Bejáró alsó"
        icon: mdi:percent

motion_sensor_driveway_lower_lockout:
    module: enabler
    class: RangeEnabler
    dependencies:
        - locker
        - motion_sensor_driveway_lower_average
    entity: sensor.motion_sensor_driveway_lower_average
    max: 0.2

motion_sensor_driveway_lower_enabler:
    module: enabler
    class: MultiEnabler
    dependencies:
        - motion_sensor_driveway_lower_lockout
        - sun_enabler_night
        - locker
    enablers:
        - motion_sensor_driveway_lower_lockout
        - sun_enabler_night

motion_sensor_garage_history:
    module: history
    class: HistoryManager
    dependencies: locker
    entity: binary_sensor.motion_sensor_garage

motion_sensor_garage_average:
    module: history
    class: AggregatedValue
    dependencies:
        - motion_sensor_garage_history
        - locker
    manager: motion_sensor_garage_history
    target: sensor.motion_sensor_garage_average
    interval:
        hours: 1
    aggregator: mean
    attributes:
        friendly_name: "Garázs"
        icon: mdi:percent

motion_sensor_garage_lockout:
    module: enabler
    class: RangeEnabler
    dependencies:
        - locker
        - motion_sensor_garage_average
    entity: sensor.motion_sensor_garage_average
    max: 0.2

motion_sensor_garage_enabler:
    module: enabler
    class: MultiEnabler
    dependencies:
        - motion_sensor_garage_lockout
        - sun_enabler_night
        - locker
    enablers:
        - motion_sensor_garage_lockout
        - sun_enabler_night

motion_sensor_garage2_history:
    module: history
    class: HistoryManager
    dependencies: locker
    entity: binary_sensor.motion_sensor_garage2

motion_sensor_garage2_average:
    module: history
    class: AggregatedValue
    dependencies:
        - motion_sensor_garage2_history
        - locker
    manager: motion_sensor_garage2_history
    target: sensor.motion_sensor_garage2_average
    interval:
        hours: 1
    aggregator: mean
    attributes:
        friendly_name: "Garázs 2"
        icon: mdi:percent

motion_sensor_garage2_lockout:
    module: enabler
    class: RangeEnabler
    dependencies:
        - locker
        - motion_sensor_garage2_average
    entity: sensor.motion_sensor_garage2_average
    max: 0.3

motion_sensor_garage2_enabler:
    module: enabler
    class: MultiEnabler
    dependencies:
        - motion_sensor_garage2_lockout
        - locker
    enablers:
        - motion_sensor_garage2_lockout

driveway_uppest_reflector_motion_sensor:
    class: MotionSensor
    module: motion_sensor
    dependencies:
        - auto_switch_light_gate_reflector
        - motion_sensor_driveway_uppest_enabler
        - locker
    sensor: binary_sensor.motion_sensor_driveway_uppest
    targets:
        - auto_switch_light_gate_reflector
    enabler: motion_sensor_driveway_uppest_enabler
    time: 1

driveway_uppest_motion_sensor:
    class: MotionSensor
    module: motion_sensor
    dependencies:
        - auto_switch_light_driveway
        - motion_sensor_driveway_uppest_enabler
        - locker
    sensor: binary_sensor.motion_sensor_driveway_uppest
    targets:
        - auto_switch_light_driveway
    enabler: motion_sensor_driveway_uppest_enabler
    time: 2

driveway_upper_reflector_motion_sensor:
    class: MotionSensor
    module: motion_sensor
    dependencies:
        - auto_switch_light_gate_reflector
        - motion_sensor_driveway_upper_enabler
        - locker
    sensor: binary_sensor.motion_sensor_driveway_upper
    targets:
        - auto_switch_light_gate_reflector
    enabler: motion_sensor_driveway_upper_enabler
    time: 1

driveway_upper_motion_sensor:
    class: MotionSensor
    module: motion_sensor
    dependencies:
        - auto_switch_light_driveway
        - motion_sensor_driveway_upper_enabler
        - locker
    sensor: binary_sensor.motion_sensor_driveway_upper
    targets:
        - auto_switch_light_driveway
    enabler: motion_sensor_driveway_upper_enabler
    time: 2

driveway_lower_motion_sensor:
    class: MotionSensor
    module: motion_sensor
    dependencies:
        - auto_switch_light_driveway
        - motion_sensor_driveway_lower_enabler
        - locker
    sensor: binary_sensor.motion_sensor_driveway_lower
    targets:
        - auto_switch_light_driveway
    enabler: motion_sensor_driveway_lower_enabler
    time: 2

garage_motion_sensor:
    class: MotionSensor
    module: motion_sensor
    dependencies:
        - auto_switch_light_garage
        - motion_sensor_garage_enabler
        - locker
    sensor: binary_sensor.motion_sensor_garage
    targets:
        - auto_switch_light_garage
    enabler: motion_sensor_garage_enabler
    time: 1

garage2_motion_sensor:
    class: MotionSensor
    module: motion_sensor
    dependencies:
        - auto_switch_light_garage
        - motion_sensor_garage2_enabler
        - locker
    sensor: binary_sensor.motion_sensor_garage2
    targets:
        - auto_switch_light_garage
    enabler: motion_sensor_garage2_enabler
    time: 2

christmas_light_switch_front:
    module: auto_switch
    class: AutoSwitch
    dependencies: locker
    target: switch.light_christmas_front
    switch: input_select.light_christmas_front

christmas_light_switch_tree:
    module: auto_switch
    class: AutoSwitch
    dependencies: locker
    target: switch.light_christmas_tree
    switch: input_select.light_christmas_tree

christmas_lights_date_enabler:
    module: enabler
    class: DateEnabler
    dependencies: locker
    begin: 11-15
    end: 02-28

christmas_lights_enabler:
    module: enabler
    class: MultiEnabler
    dependencies:
        - christmas_lights_date_enabler
        - sun_enabler_night
        - locker
    enablers:
        - christmas_lights_date_enabler
        - sun_enabler_night

christmas_light_switcher:
    class: EnabledSwitch
    module: enabled_switch
    dependencies:
        - christmas_light_switch_front
        - christmas_light_switch_tree
        - christmas_lights_enabler
        - locker
    global_dependencies:
        - auto_switch
    enabler: christmas_lights_enabler
    targets:
        - christmas_light_switch_front
        - christmas_light_switch_tree

light_outside_switcher_1:
    class: EnabledSwitch
    module: enabled_switch
    dependencies:
        - light_outside_switcher_1
        - locker
    global_dependencies:
        - auto_switch
    enabler: sun_enabler_night
    targets:
        - light_outside_switcher_1

light_outside_2_3_enabler:
    module: enabler
    class: ExpressionEnabler
    expr: 'e.sun_enabler_night and v["input_select.lighting_mode"] != "sleep"'
    dependencies:
        - sun_enabler_night
        - locker

light_outside_switcher_2_3:
    class: EnabledSwitch
    module: enabled_switch
    dependencies:
        - light_outside_switcher_2
        - light_outside_switcher_3
        - locker
    global_dependencies:
        - auto_switch
    enabler: light_outside_2_3_enabler
    targets:
        - light_outside_switcher_2
        - light_outside_switcher_3

light_outside_4_5_6_enabler:
    module: enabler
    class: ExpressionEnabler
    expr: 'e.sun_enabler_night and v["input_select.lighting_mode"] == "home"'
    dependencies:
        - sun_enabler_night
        - locker

light_outside_switcher_4_5_6:
    class: EnabledSwitch
    module: enabled_switch
    dependencies:
        - light_outside_switcher_4
        - light_outside_switcher_5
        - light_outside_switcher_6
        - locker
    global_dependencies:
        - auto_switch
    enabler: light_outside_4_5_6_enabler
    targets:
        - light_outside_switcher_4
        - light_outside_switcher_5
        - light_outside_switcher_6
